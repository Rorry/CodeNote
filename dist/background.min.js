var Client=function(a){this.consumerKey=a.consumerKey,this.consumerSecret=a.consumerSecret,this.callbackUrl=a.callbackUrl,this.serviceHost=a.serviceHost};Client.prototype.PARAM_KEYS={OAUTH_TOKEN:"oauth_token",OAUTH_TOKEN_SECRET:"oauth_token_secret",OAUTH_VERIFIER:"oauth_verifier",EDAM_NOTESTOREURL:"edam_noteStoreUrl",EDAM_USERID:"edam_userId",EXPIRES:"expires"},Client.prototype.authorise=function(){this.getRequestToken()},Client.prototype.tabListener=function(a){var b=this;return function c(d,e){var f,g,h;d===a&&e.url&&"loading"===e.status&&e.url.indexOf(b.callbackUrl)>-1&&(console.log("tabListener!"),console.log(e),f=b.getParamValues(e.url.split("?")[1],["oauth_token","oauth_verifier"]),g=f.oauth_token,h=f.oauth_verifier,b.getAuthToken(g,h),chrome.tabs.onUpdated.removeListener(c),chrome.tabs.remove(d))}},Client.prototype.onRequestToken=function(a){var b=this,c=b.getParamValues(a.text,["oauth_token","oauth_token_secret"]),d=c.oauth_token,e=c.oauth_token_secret,f=b.serviceHost+"/OAuth.action?oauth_token="+d;console.log("onRequestToken!"),console.log(a),b.tokenSecret=e,chrome.tabs.create({url:f,selected:!0},function(a){chrome.tabs.onUpdated.addListener(b.tabListener(a.id))})},Client.prototype.getRequestToken=function(){var a=this,b=a.getOAuthClient(),c=function(b){a.onRequestToken(b)},d=function(a){console.log("Fail!"),console.log(a)};b.request({method:"GET",url:a.serviceHost+"/oauth",success:c,failure:d})},Client.prototype.onAuthToken=function(a){var b=this,c=b.getParamValues(a.text,["oauth_token","edam_userId","expires","edam_noteStoreUrl"]),d=decodeURIComponent(c.oauth_token),e=c.edam_userId,f=c.expires,g=decodeURIComponent(c.edam_noteStoreUrl),h={oauth_token:d,user_id:e,expires:f,note_store_url:g};console.log("onAuthToken!"),console.log(a),console.log(h),chrome.storage.local.set({evernote_credentials:h},function(){console.log("set evernote_credentials: "+h)})},Client.prototype.getAuthToken=function(a,b){var c=this,d=c.tokenSecret,e=c.getOAuthClient(),f=function(a){c.onAuthToken(a)},g=function(a){console.log("Fail!"),console.log(a)};e.setVerifier(b),e.setAccessToken([a,d]),e.request({method:"GET",url:c.serviceHost+"/oauth",success:f,failure:g})},Client.prototype.getOAuthClient=function(){var a=this,b=a.oauth;return(void 0===b||null===b)&&(b=new OAuth({consumerKey:a.consumerKey,consumerSecret:a.consumerSecret,callbackUrl:chrome.extension.getURL(a.callbackUrl),signatureMethod:"HMAC-SHA1"})),b},Client.prototype.getParamValues=function(a,b){var c,d,e=a.split("&"),f={},g={};for(c=0;c<b.length;c+=1)f[b[c]]="";for(c=0;c<e.length;c+=1)d=e[c].split("="),d[0]in f&&(g[d[0]]=d[1]);return g},window.onload=function(){var a={sandbox:"https://sandbox.evernote.com",evernote:"https://evernote.com"},b="resources/callback.html",c="rorry-8007",d="10b55cff50217dc3",e=function(e){if(a.hasOwnProperty(e)){var f=new Client({consumerKey:c,consumerSecret:d,serviceHost:a[e],callbackUrl:b});f.authorise()}},f=function(a){console.log(a)};chrome.storage.onChanged.addListener(function(a,b){console.log("On change storage!"),console.log(a),"local"===b&&a.evernote_credentials&&a.evernote_credentials.newValue&&chrome.tabs.getCurrent(function(b){if(b){var c=chrome.tabs.connect(b.id);c.postMessage({method:"onAuthorise",data:a.evernote_credentials.newValue})}})}),chrome.browserAction.onClicked.addListener(function(a){var b=chrome.tabs.connect(a.id);b.postMessage({method:"init"}),b.onMessage.addListener(f),chrome.storage.local.get(["evernote_host","evernote_credentials"],function(a){var c=a.evernote_host||"sandbox",d=a.evernote_credentials;d?b.postMessage({method:"onAuthorise",data:d}):e(c)})})};